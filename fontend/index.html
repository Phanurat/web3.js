<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Challenge with MetaMask Login</title>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.3.5/dist/web3.min.js"></script>
</head>
<body>
    <h1>Math Challenge</h1>
    
    <!-- ส่วนของการล็อกอินด้วย MetaMask -->
    <button id="loginButton">Login with MetaMask</button>
    <p id="accountDisplay"></p>

    <!-- แสดงโจทย์คณิตศาสตร์และการตอบ -->
    <div id="mathChallenge" style="display:none;">
        <p id="question"></p>
        <input type="number" id="answer" placeholder="Your answer">
        <button id="submitAnswer">Submit Answer</button>
    </div>

    <p id="result"></p>

    <script>
        let web3;
        let userAccount;
        const contractAddress = "0xYourSmartContractAddress";  // ใส่ Smart Contract Address
        const abi = [...];  // ใส่ ABI ของ Smart Contract

        // ฟังก์ชันสำหรับเชื่อมต่อกับ MetaMask
        async function connectMetaMask() {
            if (window.ethereum) {
                try {
                    web3 = new Web3(window.ethereum);
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const accounts = await web3.eth.getAccounts();
                    userAccount = accounts[0];
                    document.getElementById("accountDisplay").textContent = "Connected: " + userAccount;

                    // ซ่อนปุ่มล็อกอินและแสดงส่วนตอบโจทย์
                    document.getElementById("loginButton").style.display = 'none';
                    document.getElementById("mathChallenge").style.display = 'block';
                } catch (error) {
                    console.error("User denied account access");
                }
            } else {
                alert("Please install MetaMask!");
            }
        }

        // สร้างโจทย์คณิตศาสตร์
        const num1 = Math.floor(Math.random() * 10) * 10;
        const num2 = Math.floor(Math.random() * 10);
        document.getElementById("question").textContent = `What is ${num1} + ${num2}?`;

        // ฟังก์ชันตรวจสอบคำตอบ
        document.getElementById("submitAnswer").addEventListener("click", async function() {
            const answer = parseInt(document.getElementById("answer").value);
            if (answer === num1 + num2) {
                document.getElementById("result").textContent = "Correct! Sending reward...";

                // สร้าง instance ของ smart contract
                const contract = new web3.eth.Contract(abi, contractAddress);

                // ส่งธุรกรรมไปยัง Smart Contract เพื่อโอนเหรียญ
                contract.methods.rewardUser(userAccount).send({
                    from: userAccount
                })
                .on('receipt', function(receipt) {
                    document.getElementById("result").textContent = "Reward sent!";
                })
                .on('error', function(error) {
                    document.getElementById("result").textContent = "Error: " + error.message;
                });
            } else {
                document.getElementById("result").textContent = "Wrong answer, try again!";
            }
        });

        // เมื่อผู้ใช้คลิกที่ปุ่มล็อกอิน
        document.getElementById("loginButton").addEventListener("click", connectMetaMask);
    </script>
</body>
</html>
